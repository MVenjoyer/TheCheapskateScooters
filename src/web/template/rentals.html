<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–∏ –∞—Ä–µ–Ω–¥—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
        }
        header {
            background: #4c6ef5;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header a {
            background: white;
            color: #4c6ef5;
            padding: 8px 14px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
        }
        .container {
            padding: 20px;
            max-width: 1000px;
            margin: auto;
        }
        h2 {
            margin-top: 30px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4c6ef5;
        }
        .card.history {
            border-left-color: #adb5bd;
        }
        .empty {
            color: #777;
            font-style: italic;
        }
    </style>
</head>
<body>

<header>
    <h1>–ú–æ–∏ –∞—Ä–µ–Ω–¥—ã</h1>
    <a href="#" onclick="window.history.back(); return false;">‚Üê –ù–∞–∑–∞–¥</a>
</header>

<div class="container">

    <h2>üöÄ –¢–µ–∫—É—â–∏–µ –∞—Ä–µ–Ω–¥—ã</h2>
    {% if active_rentals %}
        {% for rental in active_rentals %}
        <div class="card">
            <strong>{{ rental.scooter.name }}</strong><br>
            –ù–∞—á–∞–ª–æ: {{ rental.start_time|date:"d.m.Y H:i" }}

            <button class="cancel-btn"
                    onclick="cancelRental({{ rental.id }})"
                    data-rental-id="{{ rental.id }}">
                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∞—Ä–µ–Ω–¥—É
            </button>
        </div>
        {% endfor %}
    {% else %}
        <p class="empty">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥</p>
    {% endif %}

    <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –∞—Ä–µ–Ω–¥</h2>
    {% if past_rentals %}
        {% for rental in past_rentals %}
        <div class="card history">
            <strong>{{ rental.scooter.name }}</strong><br>
            {{ rental.start_time|date:"d.m.Y H:i" }} ‚Äî {{ rental.end_time|date:"d.m.Y H:i" }}
            <br>
            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ rental.total_price }} —Ä—É–±.
        </div>
        {% endfor %}
    {% else %}
        <p class="empty">–ò—Å—Ç–æ—Ä–∏—è –∞—Ä–µ–Ω–¥ –ø—É—Å—Ç–∞</p>
    {% endif %}

</div>

<script>

    function cancelRental(rentalId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∞—Ä–µ–Ω–¥—É?')) {
            return;
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    fetch(`/api/de-rent/${rentalId}/`, {
                        method: 'POST',
                        body: JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            const rentalCard = document.querySelector(`[data-rental-id="${rentalId}"]`).closest('.card');
                            if (rentalCard) {
                                rentalCard.remove();
                            }
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∞—Ä–µ–Ω–¥—ã');
                    });
                },
                function(error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é:', error.message);

                    fetch(`/api/de-rent/${rentalId}/`, {
                        method: 'POST',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('–ê—Ä–µ–Ω–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏)');
                            const rentalCard = document.querySelector(`[data-rental-id="${rentalId}"]`).closest('.card');
                            if (rentalCard) {
                                rentalCard.remove();
                            }
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + data.message);
                        }
                    });
                }
            );
        } else {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ü–æ–∑–∏—Ü–∏—è –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');

            fetch(`/api/de-rent/${rentalId}/`, {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ê—Ä–µ–Ω–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏)');
                    const rentalCard = document.querySelector(`[data-rental-id="${rentalId}"]`).closest('.card');
                    if (rentalCard) {
                        rentalCard.remove();
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            });
        }
    }

</script>


</body>
</html>
